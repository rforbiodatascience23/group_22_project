---
title: "06_analysis_2"
author: "group22"
format:
  html:
    embed-resources: true
editor: visual
---

```{r}
df <- read_tsv("../data/03_dat_aug.tsv")

head(df)
```

```{r}
sapply(df,class)
numeriques <- which(sapply(df,is.numeric))
numeriques
```

```{r}
df_num = df[,numeriques]
```

# PCA

explain this

```{r}
library(tidyverse)

pca_fit <- df |> 
  select_if(where(is.numeric)) |>
  prcomp(scale = TRUE)
```

```{r}
library(dplyr)
library(broom)
library(cowplot)

pca_fit <- prcomp(df |> 
           select_if(is.numeric), scale = TRUE)

df_augmented <- augment(pca_fit, df)

ggplot(df_augmented, aes(.fittedPC1, 
                         .fittedPC2, 
                         color = Diabetes_Status)) + 
  geom_point(size = 1.5) +
  scale_color_manual(
    values = c("Non-Diabetic" = "#D55E00", 
               "Diabetic" = "#0072B2")) +
  theme_minimal() +
  background_grid()
```

```{r}
pca_fit |>
  tidy(matrix = "rotation")
```

```{r}
arrow_style <- arrow(angle = 20, 
                     ends = "first", 
                     type = "closed", 
                     length = grid::unit(8, "pt"))

pca_fit |>
  tidy(matrix = "rotation") |>
  pivot_wider(names_from = "PC", 
              names_prefix = "PC", 
              values_from = "value") |>
  ggplot(aes(PC1, PC2)) +
  geom_segment(xend = 0, 
               yend = 0, 
               arrow = arrow_style) +
  geom_text(
    aes(label = column),
    hjust = 1, 
    nudge_x = -0.02, 
    color = "#904C2F") +
  xlim(-1.25, .5) + 
  ylim(-.5, 1) +
  coord_fixed() +
  theme_minimal_grid(12)
```

```{r}
pca_fit |>
  tidy(matrix = "eigenvalues")
```

```{r}
pca_fit |>
  tidy(matrix = "eigenvalues") |>
  ggplot(aes(PC, percent)) +
  geom_col(fill = "#56B4E9", alpha = 0.8) +
  scale_x_continuous(breaks = 1:22) +
  scale_y_continuous(labels = scales::percent_format(),
                     expand = expansion(mult = c(0, 0.01))) +
  theme_minimal_hgrid(12)
```

```{r}
plot(cumsum(pca_fit$sdev^2) / sum(pca_fit$sdev^2), 
     xlab = "Number of Principal Components",
     ylab = "Cumulative Proportion of Variance Explained",
     type = "b")

abline(h = 0.7, col = "red", lty = 2)
abline(h = 0.75, col = "blue", lty = 2)
abline(h = 0.8, col = "green", lty = 2)
```

# NEW MODELS

```{r}
table(df$Sex)
```

So we have more female than men.

### With the selected components that achieve the 80%. (15)

```{r}
num_components <- 15

selected_components <- pca_fit$x[, 1:num_components]

outcome_variable <- df$Diabetes_binary

set.seed(123) 
train_indices <- sample(seq_len(nrow(df)), 0.7 * nrow(df))

train_data <- selected_components[train_indices, ]
train_outcome <- outcome_variable[train_indices]
test_data <- selected_components[-train_indices, ]
test_outcome <- outcome_variable[-train_indices]

model <- glm(train_outcome ~ ., family = "binomial", data = as.data.frame(cbind(train_outcome, train_data)))

predictions <- predict(model, newdata = as.data.frame(test_data), type = "response")

binary_predictions <- ifelse(predictions > 0.5, 1, 0)

conf_matrix <- table(binary_predictions, test_outcome)
accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)

print(conf_matrix)
cat("Accuracy:", accuracy, "\n")
```

AQUÍ TENGO QUE CONSEGUIR QUE ME PONGA CUALES SON ESAS VARIABLES EN VEZ DE LOS PC...

```{r}
str(selected_components)
```

MEN VS WOMEN MODELS.

CREATE A DF FOR MEN AND ANOTHER ONE FOR WOMEN.

PERFORM BOTH MODELS.

CONCLUSIONS.
